

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Working with StatementBuilder &mdash; RepoDb 1.1.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Performance Benchmark" href="performance.html" />
    <link rel="prev" title="Working with Trace" href="trace.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> RepoDb
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction to RepoDb</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation Steps</a></li>
<li class="toctree-l1"><a class="reference internal" href="dataentity.html">Creating a DataEntity</a></li>
<li class="toctree-l1"><a class="reference internal" href="mapattribute.html">Mapping with MapAttribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="attributes.html">Property Attributes</a></li>
<li class="toctree-l1"><a class="reference internal" href="multiplemapping.html">Multiple Entity Mapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="typemapping.html">Type Mapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="connection.html">Connection Object</a></li>
<li class="toctree-l1"><a class="reference internal" href="connectionoperations.html">Connection Operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="transaction.html">Transaction</a></li>
<li class="toctree-l1"><a class="reference internal" href="expressiontree.html">Expression Tree</a></li>
<li class="toctree-l1"><a class="reference internal" href="querygroup.html">Query Group Expressions</a></li>
<li class="toctree-l1"><a class="reference internal" href="repository.html">Working with Repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="connectionpersistency.html">Connection Persistency</a></li>
<li class="toctree-l1"><a class="reference internal" href="repositoryoperations.html">Repository Operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="cache.html">Working with Cache</a></li>
<li class="toctree-l1"><a class="reference internal" href="trace.html">Working with Trace</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Working with StatementBuilder</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#querybuilder-object">QueryBuilder Object</a></li>
<li class="toctree-l2"><a class="reference internal" href="#createbatchquery-method">CreateBatchQuery Method</a></li>
<li class="toctree-l2"><a class="reference internal" href="#createcount-method">CreateCount Method</a></li>
<li class="toctree-l2"><a class="reference internal" href="#createdelete-method">CreateDelete Method</a></li>
<li class="toctree-l2"><a class="reference internal" href="#createdeleteall-method">CreateDeleteAll Method</a></li>
<li class="toctree-l2"><a class="reference internal" href="#createinlineinsert-method">CreateInlineInsert Method</a></li>
<li class="toctree-l2"><a class="reference internal" href="#createinlinemerge-method">CreateInlineMerge Method</a></li>
<li class="toctree-l2"><a class="reference internal" href="#createinlineupdate-method">CreateInlineUpdate Method</a></li>
<li class="toctree-l2"><a class="reference internal" href="#createinsert-method">CreateInsert Method</a></li>
<li class="toctree-l2"><a class="reference internal" href="#createmerge-method">CreateMerge Method</a></li>
<li class="toctree-l2"><a class="reference internal" href="#createquery-method">CreateQuery Method</a></li>
<li class="toctree-l2"><a class="reference internal" href="#createtruncate-method">CreateTruncate Method</a></li>
<li class="toctree-l2"><a class="reference internal" href="#createupdate-method">CreateUpdate Method</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-a-custom-statement-builder">Creating a custom Statement Builder</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mapping-a-statement-builder">Mapping a Statement Builder</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="performance.html">Performance Benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="extensibility.html">Library Extensibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html">Supported Versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="contact.html">Contacts</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">RepoDb</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Working with StatementBuilder</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/pages/statementbuilder.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="working-with-statementbuilder">
<h1>Working with StatementBuilder<a class="headerlink" href="#working-with-statementbuilder" title="Permalink to this headline">¶</a></h1>
<p>The library supports statement building injection, allowing the developers to override the default query statement the library is using. By default, the library is using the <cite>RepoDb.SqlDbStatementBuilder</cite> that is only working for SQL Server databases.</p>
<p>In order to override the statement builder, the developer must create a class that implements the <cite>RepoDb.Interfaces.IStatementBuilder</cite> interface. This allows the class to be injectable in the repository and implements the necessary methods needed by all operations.</p>
<p>A <cite>QueryBuilder</cite> object comes along the way when the custom statement builder is being created. This object is a helper object when composing the actual SQL Statements. See the <cite>QueryBuilder</cite> documentation.</p>
<p>Below are the methods of the <cite>IStatementBuilder</cite> interface.</p>
<ul class="simple">
<li><strong>CreateBatchQuery</strong>: called when creating a <cite>BatchQuery</cite> statement.</li>
<li><strong>CreateCount</strong>: called when creating a <cite>Count</cite> statement.</li>
<li><strong>CreateDelete</strong>: called when creating a <cite>Delete</cite> statement.</li>
<li><strong>CreateDeleteAll</strong>: called when creating a <cite>Delete</cite> statement.</li>
<li><strong>CreateInlineInsert</strong>: called when creating a <cite>InlineInsert</cite> statement.</li>
<li><strong>CreateInlineMerge</strong>: called when creating a <cite>InlineMerge</cite> statement.</li>
<li><strong>CreateInlineUpdate</strong>: called when creating a <cite>InlineUpdate</cite> statement.</li>
<li><strong>CreateInsert</strong>: called when creating a <cite>Insert</cite> statement.</li>
<li><strong>CreateMerge</strong>: called when creating a <cite>Merge</cite> statement.</li>
<li><strong>CreateQuery</strong>: called when creating a <cite>Query</cite> statement.</li>
<li><strong>CreateTruncate</strong>: called when creating a <cite>Truncate</cite> statement.</li>
<li><strong>CreateUpdate</strong>: called when creating a <cite>Update</cite> statement.</li>
</ul>
<div class="section" id="querybuilder-object">
<h2>QueryBuilder Object<a class="headerlink" href="#querybuilder-object" title="Permalink to this headline">¶</a></h2>
<p>A query builder is an helper object used when creating a query statement in the statement builders. It contains important methods that is very useful to fluently construct the statement.</p>
<p>By default, the library is using the <cite>RepoDb.QueryBuilder&lt;TEntity&gt;</cite> object when composing the statement.</p>
<p>Below is a sample code that creates a SQL Statement for the <cite>Query</cite> operation for <cite>Oracle</cite> data provide.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>public string CreateQuery&lt;TEntity&gt;(QueryBuilder&lt;TEntity&gt; queryBuilder, QueryGroup where, int? top = 0, IEnumerable&lt;OrderField&gt; orderBy = null) where TEntity : DataEntity
{
        // Create an initial SELECT statement
        queryBuilder.Clear()
                .Select()
                .Fields(Command.Query)
                .From()
                .Table(Command.Query);

        // Add all fields for WHERE
        if (where != null)
        {
                queryBuilder.Where(where);
        }

        // Add the ROWNUM (TOP in SQL Server)
        if (top &gt; 0)
        {
                // In Oracle, SELECT [Fields] FROM [Table] WHERE [Fields] AND ROWNUM &lt;=(Rows)
                queryBuilder.WriteText($&quot;AND (ROWNUM &lt;= {top})&quot;);
        }

        // End the builder
        queryBuilder.End();

        // Return the Statement
        return queryBuilder.ToString();
}
</pre></div>
</div>
</div>
<div class="section" id="createbatchquery-method">
<h2>CreateBatchQuery Method<a class="headerlink" href="#createbatchquery-method" title="Permalink to this headline">¶</a></h2>
<p>This method is being called when the <cite>BatchQuery</cite> operation of the repository is being called.</p>
<p>Below are the arguments of <cite>CreateBatchQuery</cite> method.</p>
<ul class="simple">
<li><strong>queryBuilder</strong>: the builder used when creating a statement (of type <cite>RepoDb.QueryBuilder&lt;TEntity&gt;</cite>).</li>
<li><strong>where</strong>: the expression used when creating a statement (of type <cite>RepoDb.QueryGroup</cite>).</li>
<li><strong>page</strong>: the page number implied when creating a statement.</li>
<li><strong>rowsPerBatch</strong>: the size of the rows implied when creating a statement.</li>
<li><strong>orderBy</strong>: the fields used in the <cite>ORDER BY</cite> when creating a statement.</li>
</ul>
<p>See below the actual implementation of <cite>SqlDbStatementBuilder</cite> object for <cite>CreateBatchQuery</cite> method.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>public string CreateBatchQuery&lt;TEntity&gt;(QueryBuilder&lt;TEntity&gt; queryBuilder, QueryGroup where, int page, int rowsPerBatch, IEnumerable&lt;OrderField&gt; orderBy) where TEntity : DataEntity
{
        var queryProperties = DataEntityExtension.GetPropertiesFor&lt;TEntity&gt;(Command.Query);
        var batchQueryProperties = DataEntityExtension.GetPropertiesFor&lt;TEntity&gt;(Command.BatchQuery)
                .Where(property =&gt; queryProperties.Contains(property));
        var fields = batchQueryProperties.Select(property =&gt; new Field(property.Name));

        // Build the SQL Statement
        queryBuilder = queryBuilder ?? new QueryBuilder&lt;TEntity&gt;();
        queryBuilder
                .Clear()
                .With()
                .WriteText(&quot;CTE&quot;)
                .As()
                .OpenParen()
                .Select()
                .RowNumber()
                .Over()
                .OpenParen()
                .OrderByFrom(orderBy)
                .CloseParen()
                .As(&quot;[RowNumber],&quot;)
                .FieldsFrom(Command.BatchQuery)
                .From()
                .TableFrom(Command.BatchQuery)
                .WhereFrom(where)
                .CloseParen()
                .Select()
                .FieldsFrom(fields)
                .From()
                .WriteText(&quot;CTE&quot;)
                .WriteText($&quot;WHERE ([RowNumber] BETWEEN {(page * rowsPerBatch) + 1} AND {(page + 1) * rowsPerBatch})&quot;)
                .OrderByFrom(orderBy)
                .End();

        // Return the query
        return queryBuilder.GetString();
}
</pre></div>
</div>
</div>
<div class="section" id="createcount-method">
<h2>CreateCount Method<a class="headerlink" href="#createcount-method" title="Permalink to this headline">¶</a></h2>
<p>This method is being called when the <cite>Count</cite> operation of the repository is being called.</p>
<p>Below are the arguments of <cite>CreateCount</cite> method.</p>
<ul class="simple">
<li><strong>queryBuilder</strong>: the builder used when creating a statement (of type <cite>RepoDb.QueryBuilder&lt;TEntity&gt;</cite>).</li>
<li><strong>where</strong>: the expression used when creating a statement (of type <cite>RepoDb.QueryGroup</cite>).</li>
</ul>
<p>See below the actual implementation of <cite>SqlDbStatementBuilder</cite> object for <cite>CreateCount</cite> method.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>public string CreateCount&lt;TEntity&gt;(QueryBuilder&lt;TEntity&gt; queryBuilder, QueryGroup where) where TEntity : DataEntity
{
        queryBuilder = queryBuilder ?? new QueryBuilder&lt;TEntity&gt;();
        queryBuilder
                .Clear()
                .Select()
                .CountBig()
                .WriteText(&quot;(1) AS [Counted]&quot;)
                .From()
                .TableFrom(Command.Count)
                .WhereFrom(where)
                .End();
        return queryBuilder.GetString();
}
</pre></div>
</div>
</div>
<div class="section" id="createdelete-method">
<h2>CreateDelete Method<a class="headerlink" href="#createdelete-method" title="Permalink to this headline">¶</a></h2>
<p>This method is being called when the <cite>Delete</cite> operation of the repository is being called.</p>
<p>Below are the arguments of <cite>CreateDelete</cite> method.</p>
<ul class="simple">
<li><strong>queryBuilder</strong>: the builder used when creating a statement (of type <cite>RepoDb.QueryBuilder&lt;TEntity&gt;</cite>).</li>
<li><strong>where</strong>: the expression used when composing a statement (of type <cite>RepoDb.QueryGroup</cite>).</li>
</ul>
<p>See below the actual implementation of <cite>SqlDbStatementBuilder</cite> object for <cite>CreateDelete</cite> method.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>public string CreateDelete&lt;TEntity&gt;(QueryBuilder&lt;TEntity&gt; queryBuilder, QueryGroup where) where TEntity : DataEntity
{
        queryBuilder = queryBuilder ?? new QueryBuilder&lt;TEntity&gt;();
        queryBuilder
                .Clear()
                .Delete()
                .From()
                .TableFrom(Command.Delete)
                .WhereFrom(where)
                .End();
        return queryBuilder.GetString();
}
</pre></div>
</div>
</div>
<div class="section" id="createdeleteall-method">
<h2>CreateDeleteAll Method<a class="headerlink" href="#createdeleteall-method" title="Permalink to this headline">¶</a></h2>
<p>This method is being called when the <cite>DeleteAll</cite> operation of the repository is being called.</p>
<p>Below are the arguments of <cite>CreateDeleteAll</cite> method.</p>
<ul class="simple">
<li><strong>queryBuilder</strong>: the builder used when creating a statement (of type <cite>RepoDb.QueryBuilder&lt;TEntity&gt;</cite>).</li>
</ul>
<p>See below the actual implementation of <cite>SqlDbStatementBuilder</cite> object for <cite>CreateDeleteAll</cite> method.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>public string CreateDeleteAll&lt;TEntity&gt;(QueryBuilder&lt;TEntity&gt; queryBuilder) where TEntity : DataEntity
{
        queryBuilder = queryBuilder ?? new QueryBuilder&lt;TEntity&gt;();
        queryBuilder
                .Clear()
                .Delete()
                .From()
                .TableFrom(Command.DeleteAll)
                .End();
        return queryBuilder.GetString();
}
</pre></div>
</div>
</div>
<div class="section" id="createinlineinsert-method">
<h2>CreateInlineInsert Method<a class="headerlink" href="#createinlineinsert-method" title="Permalink to this headline">¶</a></h2>
<p>This method is being called when the <cite>InlineInsert</cite> operation of the repository is being called.</p>
<p>Below are the arguments of <cite>CreateInlineInsert</cite> method.</p>
<ul class="simple">
<li><strong>queryBuilder</strong>: an instance of query builder used to build the SQL statement.</li>
<li><strong>fields</strong>: the list of the fields to be a part of the inline merge operation in SQL Statement composition.</li>
<li><strong>overrideIgnore</strong>: the flag used to identify whether all the ignored fields will be included in the operation when composing a statement.</li>
</ul>
<p>See below the actual implementation of <cite>SqlDbStatementBuilder</cite> object for <cite>CreateInlineInsert</cite> method.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>public string CreateInlineInsert&lt;TEntity&gt;(QueryBuilder&lt;TEntity&gt; queryBuilder, IEnumerable&lt;Field&gt; fields, bool? overrideIgnore = false)
        where TEntity : DataEntity
{
        return CreateInlineInsert&lt;TEntity&gt;(queryBuilder, fields, overrideIgnore, false);
}

internal string CreateInlineInsert&lt;TEntity&gt;(QueryBuilder&lt;TEntity&gt; queryBuilder, IEnumerable&lt;Field&gt; fields,
        bool? overrideIgnore = false, bool isPrimaryIdentity = false)
        where TEntity : DataEntity
{
        var primary = DataEntityExtension.GetPrimaryProperty&lt;TEntity&gt;();
        var hasFields = isPrimaryIdentity ? fields?.Any(field =&gt; field.Name.ToLower() != primary?.GetMappedName().ToLower()) : fields.Any();

        // Check if there are fields
        if (hasFields == false)
        {
                throw new InvalidOperationException($&quot;No inline insertable fields found at type &#39;{typeof(TEntity).FullName}&#39;.&quot;);
        }

        // Check for the unmatches
        if (overrideIgnore == false)
        {
                var insertableProperties = DataEntityExtension.GetPropertiesFor&lt;TEntity&gt;(Command.Insert);
                var inlineInsertableProperties = DataEntityExtension.GetPropertiesFor&lt;TEntity&gt;(Command.InlineInsert)
                        .Where(property =&gt; insertableProperties.Contains(property))
                        .Select(property =&gt; property.GetMappedName());
                var unmatchesProperties = fields?.Where(field =&gt;
                        inlineInsertableProperties?.FirstOrDefault(property =&gt;
                                field.Name.ToLower() == property.ToLower()) == null);
                if (unmatchesProperties.Count() &gt; 0)
                {
                        throw new InvalidOperationException($&quot;The fields &#39;{unmatchesProperties.Select(field =&gt; field.AsField()).Join(&quot;, &quot;)}&#39; are not &quot; +
                                $&quot;inline insertable for object &#39;{DataEntityExtension.GetMappedName&lt;TEntity&gt;(Command.InlineInsert)}&#39;.&quot;);
                }
        }

        // Check for the primary key
        if (primary != null &amp;&amp; isPrimaryIdentity)
        {
                fields = fields?
                        .Where(field =&gt; field.Name.ToLower() != primary.Name.ToLower())
                                .Select(field =&gt; field);
        }

        // Build the SQL Statement
        queryBuilder = queryBuilder ?? new QueryBuilder&lt;TEntity&gt;();
        queryBuilder
                .Clear()
                .Insert()
                .Into()
                .TableFrom(Command.Insert)
                .OpenParen()
                .FieldsFrom(fields)
                .CloseParen()
                .Values()
                .OpenParen()
                .ParametersFrom(fields)
                .CloseParen()
                .End();
        var result = isPrimaryIdentity ? &quot;SCOPE_IDENTITY()&quot; : (primary != null) ? $&quot;@{primary.GetMappedName()}&quot; : &quot;NULL&quot;;
        queryBuilder
                .Select()
                .WriteText(result)
                .As(&quot;[Result]&quot;)
                .End();

        // Return the query
        return queryBuilder.GetString();
}
</pre></div>
</div>
</div>
<div class="section" id="createinlinemerge-method">
<h2>CreateInlineMerge Method<a class="headerlink" href="#createinlinemerge-method" title="Permalink to this headline">¶</a></h2>
<p>This method is being called when the <cite>InlineMerge</cite> operation of the repository is being called.</p>
<p>Below are the arguments of <cite>CreateInlineMerge</cite> method.</p>
<ul class="simple">
<li><strong>queryBuilder</strong>: an instance of query builder used to build the SQL statement.</li>
<li><strong>fields</strong>: the list of the fields to be a part of the inline merge operation in SQL Statement composition.</li>
<li><strong>qualifiers</strong>: the list of the qualifier fields to be used by the inline merge operation on a SQL Statement.</li>
<li><strong>overrideIgnore</strong>: the flag used to identify whether all the ignored fields will be included in the operation when composing a statement.</li>
</ul>
<p>See below the actual implementation of <cite>SqlDbStatementBuilder</cite> object for <cite>CreateInlineUpdate</cite> method.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>public string CreateInlineMerge&lt;TEntity&gt;(QueryBuilder&lt;TEntity&gt; queryBuilder, IEnumerable&lt;Field&gt; fields, IEnumerable&lt;Field&gt; qualifiers, bool? overrideIgnore = false)
        where TEntity : DataEntity
{
        return CreateInlineMerge&lt;TEntity&gt;(queryBuilder, fields, qualifiers, overrideIgnore, false);
}

internal string CreateInlineMerge&lt;TEntity&gt;(QueryBuilder&lt;TEntity&gt; queryBuilder, IEnumerable&lt;Field&gt; fields, IEnumerable&lt;Field&gt; qualifiers,
        bool? overrideIgnore = false, bool isPrimaryIdentity = false)
        where TEntity : DataEntity
{
        var primary = DataEntityExtension.GetPrimaryProperty&lt;TEntity&gt;();

        // Get all target properties
        var mergeableProperties = DataEntityExtension.GetPropertiesFor&lt;TEntity&gt;(Command.Merge);
        var inlineMergeableProperties = DataEntityExtension.GetPropertiesFor&lt;TEntity&gt;(Command.InlineMerge)
                .Where(property =&gt; mergeableProperties.Contains(property));

        // Check for the unmatches
        if (overrideIgnore == false)
        {
                var unmatchesProperties = fields?.Where(field =&gt;
                        inlineMergeableProperties?.FirstOrDefault(property =&gt; field.Name.ToLower() == property.GetMappedName().ToLower()) == null);
                                //.Where(property =&gt; property.Name.ToLower() != primary?.GetMappedName().ToLower());
                if (unmatchesProperties.Count() &gt; 0)
                {
                        throw new InvalidOperationException($&quot;The fields &#39;{unmatchesProperties.Select(field =&gt; field.AsField()).Join(&quot;, &quot;)}&#39; are not &quot; +
                                $&quot;inline mergeable for object &#39;{DataEntityExtension.GetMappedName&lt;TEntity&gt;(Command.InlineMerge)}&#39;.&quot;);
                }
        }

        // Use the primary for qualifiers if there is no any
        if (qualifiers == null &amp;&amp; primary != null)
        {
                qualifiers = Field.From(primary.GetMappedName());
        }

        // Get all target fields
        var insertableProperties = DataEntityExtension.GetPropertiesFor&lt;TEntity&gt;(Command.Insert)
                .Where(property =&gt; !(isPrimaryIdentity &amp;&amp; property == primary));
        var updateableProperties = DataEntityExtension.GetPropertiesFor&lt;TEntity&gt;(Command.Update)
                .Where(property =&gt; property != primary);
        var mergeInsertableFields = mergeableProperties
                .Where(property =&gt; insertableProperties.Contains(property) &amp;&amp;
                        mergeableProperties.Contains(property) &amp;&amp;
                                inlineMergeableProperties.Contains(property))
                .Where(property =&gt;
                        fields.Any(field =&gt; field.Name.ToLower() == property.GetMappedName().ToLower()))
                .Select(property =&gt; new Field(property.Name));
        var mergeUpdateableFields = mergeableProperties
                .Where(property =&gt; updateableProperties.Contains(property) &amp;&amp;
                        mergeableProperties.Contains(property) &amp;&amp;
                                inlineMergeableProperties.Contains(property))
                .Where(property =&gt;
                        fields.Any(field =&gt; field.Name.ToLower() == property.GetMappedName().ToLower()))
                .Select(property =&gt; new Field(property.Name));

        // Check if there are inline mergeable fields (for insert)
        if (!mergeInsertableFields.Any())
        {
                throw new InvalidOperationException($&quot;No inline mergeable fields (for insert) found at type &#39;{typeof(TEntity).FullName}&#39;.&quot;);
        }

        // Check if there are inline mergeable fields (for update)
        if (!mergeUpdateableFields.Any())
        {
                throw new InvalidOperationException($&quot;No inline mergeable fields (for update) found at type &#39;{typeof(TEntity).FullName}&#39;.&quot;);
        }

        // Build the SQL Statement
        queryBuilder = queryBuilder ?? new QueryBuilder&lt;TEntity&gt;();
        queryBuilder
                .Clear()
                // MERGE T USING S
                .Merge()
                .TableFrom(Command.Merge)
                .As(&quot;T&quot;)
                .Using()
                .OpenParen()
                .Select()
                .ParametersAsFieldsFrom(fields)
                .CloseParen()
                .As(&quot;S&quot;)
                // QUALIFIERS
                .On()
                .OpenParen()
                .WriteText(qualifiers?
                        .Select(
                                field =&gt; field.AsJoinQualifier(&quot;S&quot;, &quot;T&quot;))
                                        .Join($&quot; {StringConstant.And.ToUpper()} &quot;))
                .CloseParen()
                // WHEN NOT MATCHED THEN INSERT VALUES
                .When()
                .Not()
                .Matched()
                .Then()
                .Insert()
                .OpenParen()
                .FieldsFrom(mergeInsertableFields)
                .CloseParen()
                .Values()
                .OpenParen()
                .ParametersFrom(mergeInsertableFields)
                .CloseParen()
                // WHEN MATCHED THEN UPDATE SET
                .When()
                .Matched()
                .Then()
                .Update()
                .Set()
                .FieldsAndAliasFieldsFrom(mergeUpdateableFields, &quot;S&quot;)
                .End();

        // Return the query
        return queryBuilder.GetString();
}
</pre></div>
</div>
</div>
<div class="section" id="createinlineupdate-method">
<h2>CreateInlineUpdate Method<a class="headerlink" href="#createinlineupdate-method" title="Permalink to this headline">¶</a></h2>
<p>This method is being called when the <cite>InlineUpdate</cite> operation of the repository is being called.</p>
<p>Below are the arguments of <cite>CreateInlineUpdate</cite> method.</p>
<ul class="simple">
<li><strong>queryBuilder</strong>: an instance of query builder used to build the SQL statement.</li>
<li><strong>fields</strong>: the list of the fields to be a part of the inline merge operation in SQL Statement composition.</li>
<li><strong>where</strong>: the expression used when composing a statement (of type <cite>RepoDb.QueryGroup</cite>).</li>
<li><strong>overrideIgnore</strong>: the flag used to identify whether all the ignored fields will be included in the operation when composing a statement.</li>
</ul>
<p>See below the actual implementation of <cite>SqlDbStatementBuilder</cite> object for <cite>CreateInlineUpdate</cite> method.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>public string CreateInlineUpdate&lt;TEntity&gt;(QueryBuilder&lt;TEntity&gt; queryBuilder, IEnumerable&lt;Field&gt; fields,
        QueryGroup where, bool? overrideIgnore = false)
        where TEntity : DataEntity
{
        var primary = DataEntityExtension.GetPrimaryProperty&lt;TEntity&gt;();
        var hasFields = fields?.Any(field =&gt; field.Name.ToLower() != primary?.GetMappedName().ToLower());

        // Check if there are fields
        if (hasFields == false)
        {
                throw new InvalidOperationException($&quot;No inline updatable fields found at type &#39;{typeof(TEntity).FullName}&#39;.&quot;);
        }

        // Get the target properties
        var updateableProperties = DataEntityExtension.GetPropertiesFor&lt;TEntity&gt;(Command.Update);
        var inlineUpdateableProperties = DataEntityExtension.GetPropertiesFor&lt;TEntity&gt;(Command.InlineUpdate)
                .Where(property =&gt; property != primary &amp;&amp; updateableProperties.Contains(property))
                .Select(property =&gt; property.GetMappedName());

        // Check for the unmatches
        if (overrideIgnore == false)
        {
                var unmatchesProperties = fields?.Where(field =&gt;
                        inlineUpdateableProperties?.FirstOrDefault(property =&gt; field.Name.ToLower() == property.ToLower()) == null);
                if (unmatchesProperties.Count() &gt; 0)
                {
                        throw new InvalidOperationException($&quot;The fields &#39;{unmatchesProperties.Select(field =&gt; field.AsField()).Join(&quot;, &quot;)}&#39; are not &quot; +
                                $&quot;inline updateable for object &#39;{DataEntityExtension.GetMappedName&lt;TEntity&gt;(Command.InlineUpdate)}&#39;.&quot;);
                }
        }

        // Build the SQL Statement
        queryBuilder = queryBuilder ?? new QueryBuilder&lt;TEntity&gt;();
        queryBuilder
                .Clear()
                .Update()
                .TableFrom(Command.InlineUpdate)
                .Set()
                .FieldsAndParametersFrom(fields)
                .WhereFrom(where)
                .End();

        // Return the query
        return queryBuilder.GetString();
}
</pre></div>
</div>
</div>
<div class="section" id="createinsert-method">
<h2>CreateInsert Method<a class="headerlink" href="#createinsert-method" title="Permalink to this headline">¶</a></h2>
<p>This method is being called when the <cite>Insert</cite> operation of the repository is being called.</p>
<p>Below are the arguments of <cite>CreateInsert</cite> method.</p>
<ul class="simple">
<li><strong>queryBuilder</strong>: an instance of query builder used to build the SQL statement.</li>
</ul>
<p>See below the actual implementation of <cite>SqlDbStatementBuilder</cite> object for <cite>CreateInsert</cite> method.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>public string CreateInsert&lt;TEntity&gt;(QueryBuilder&lt;TEntity&gt; queryBuilder)
        where TEntity : DataEntity
{
        return CreateInsert(queryBuilder, false);
}

internal string CreateInsert&lt;TEntity&gt;(QueryBuilder&lt;TEntity&gt; queryBuilder, bool isPrimaryIdentity)
        where TEntity : DataEntity
{
        var primary = DataEntityExtension.GetPrimaryProperty&lt;TEntity&gt;();
        var fields = DataEntityExtension.GetPropertiesFor&lt;TEntity&gt;(Command.Insert)
                .Where(property =&gt; !(isPrimaryIdentity &amp;&amp; property == primary))
                .Select(p =&gt; new Field(p.Name));

        // Build the SQL Statement
        queryBuilder = queryBuilder ?? new QueryBuilder&lt;TEntity&gt;();
        queryBuilder
                .Clear()
                .Insert()
                .Into()
                .TableFrom(Command.Insert)
                .OpenParen()
                .FieldsFrom(fields)
                .CloseParen()
                .Values()
                .OpenParen()
                .ParametersFrom(fields)
                .CloseParen()
                .End();
        var result = isPrimaryIdentity ? &quot;SCOPE_IDENTITY()&quot; : (primary != null) ? $&quot;@{primary.GetMappedName()}&quot; : &quot;NULL&quot;;
        queryBuilder
                .Select()
                .WriteText(result)
                .As(&quot;[Result]&quot;)
                .End();

        // Return the query
        return queryBuilder.GetString();
}
</pre></div>
</div>
</div>
<div class="section" id="createmerge-method">
<h2>CreateMerge Method<a class="headerlink" href="#createmerge-method" title="Permalink to this headline">¶</a></h2>
<p>This method is being called when the <cite>Merge</cite> operation of the repository is being called.</p>
<p>Below are the arguments of <cite>CreateMerge</cite> method.</p>
<ul class="simple">
<li><strong>queryBuilder</strong>: an instance of query builder used to build the SQL statement.</li>
<li><strong>qualifiers</strong>: the list of fields to be used as a qualifiers when composing a statement (on enumerable of type <cite>RepoDb.Field</cite>).</li>
</ul>
<p>See below the actual implementation of <cite>SqlDbStatementBuilder</cite> object for <cite>CreateMerge</cite> method.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>public string CreateMerge&lt;TEntity&gt;(QueryBuilder&lt;TEntity&gt; queryBuilder, IEnumerable&lt;Field&gt; qualifiers)
        where TEntity : DataEntity
{
        return CreateMerge(queryBuilder, qualifiers);
}

internal string CreateMerge&lt;TEntity&gt;(QueryBuilder&lt;TEntity&gt; queryBuilder, IEnumerable&lt;Field&gt; qualifiers, bool isPrimaryIdentity)
        where TEntity : DataEntity
{
        var primary = DataEntityExtension.GetPrimaryProperty&lt;TEntity&gt;();

        // Add the primary key as the default qualifier
        if (qualifiers == null &amp;&amp; primary != null)
        {
                qualifiers = Field.From(primary.GetMappedName());
        }

        // Get the target properties
        var insertableProperties = DataEntityExtension.GetPropertiesFor&lt;TEntity&gt;(Command.Insert)
                .Where(property =&gt; !(isPrimaryIdentity &amp;&amp; property == primary));
        var updateableProperties = DataEntityExtension.GetPropertiesFor&lt;TEntity&gt;(Command.Merge)
                .Where(property =&gt; property != primary);
        var mergeableProperties = DataEntityExtension.GetPropertiesFor&lt;TEntity&gt;(Command.Merge);
        var mergeInsertableFields = mergeableProperties
                .Where(property =&gt; insertableProperties.Contains(property))
                .Select(property =&gt; new Field(property.Name));
        var mergeUpdateableFields = mergeableProperties
                .Where(property =&gt; updateableProperties.Contains(property))
                .Select(property =&gt; new Field(property.Name));

        // Build the SQL Statement
        queryBuilder = queryBuilder ?? new QueryBuilder&lt;TEntity&gt;();
        queryBuilder
                .Clear()
                // MERGE T USING S
                .Merge()
                .TableFrom(Command.Merge)
                .As(&quot;T&quot;)
                .Using()
                .OpenParen()
                .Select()
                .ParametersAsFieldsFrom(Command.None) // All fields must be included for selection
                .CloseParen()
                .As(&quot;S&quot;)
                // QUALIFIERS
                .On()
                .OpenParen()
                .WriteText(qualifiers?
                        .Select(
                                field =&gt; field.AsJoinQualifier(&quot;S&quot;, &quot;T&quot;))
                                        .Join($&quot; {StringConstant.And.ToUpper()} &quot;))
                .CloseParen()
                // WHEN NOT MATCHED THEN INSERT VALUES
                .When()
                .Not()
                .Matched()
                .Then()
                .Insert()
                .OpenParen()
                .FieldsFrom(mergeInsertableFields)
                .CloseParen()
                .Values()
                .OpenParen()
                .ParametersFrom(mergeInsertableFields)
                .CloseParen()
                // WHEN MATCHED THEN UPDATE SET
                .When()
                .Matched()
                .Then()
                .Update()
                .Set()
                .FieldsAndAliasFieldsFrom(mergeUpdateableFields, &quot;S&quot;)
                .End();

        // Return the query
        return queryBuilder.GetString();
}
</pre></div>
</div>
</div>
<div class="section" id="createquery-method">
<h2>CreateQuery Method<a class="headerlink" href="#createquery-method" title="Permalink to this headline">¶</a></h2>
<p>This method is being called when the <cite>Query</cite> operation of the repository is being called.</p>
<p>Below are the arguments of <cite>CreateQuery</cite> method.</p>
<ul class="simple">
<li><strong>queryBuilder</strong>: an instance of query builder used to build the SQL statement.</li>
<li><strong>where</strong>: the expression used when composing a statement (of type <cite>RepoDb.QueryGroup</cite>).</li>
<li><strong>top</strong>: the value that identifies the number of rows to be returned when composing a statement.</li>
<li><strong>orderBy</strong>: the fields used in the <cite>ORDER BY</cite> when creating a statement.</li>
</ul>
<p>See below the actual implementation of <cite>SqlDbStatementBuilder</cite> object for <cite>CreateQuery</cite> method.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>public string CreateQuery&lt;TEntity&gt;(QueryBuilder&lt;TEntity&gt; queryBuilder, QueryGroup where, int? top = 0, IEnumerable&lt;OrderField&gt; orderBy = null)
        where TEntity : DataEntity
{
        queryBuilder = queryBuilder ?? new QueryBuilder&lt;TEntity&gt;();
        queryBuilder
                .Clear()
                .Select()
                .TopFrom(top)
                .FieldsFrom(Command.Query)
                .From()
                .TableFrom(Command.Query)
                .WhereFrom(where)
                .OrderByFrom(orderBy)
                .End();
        return queryBuilder.GetString();
}
</pre></div>
</div>
</div>
<div class="section" id="createtruncate-method">
<h2>CreateTruncate Method<a class="headerlink" href="#createtruncate-method" title="Permalink to this headline">¶</a></h2>
<p>This method is being called when the <cite>Truncate</cite> operation of the repository is being called.</p>
<p>Below are the arguments of <cite>CreateTruncate</cite> method.</p>
<ul class="simple">
<li><strong>queryBuilder</strong>: an instance of query builder used to build the SQL statement.</li>
</ul>
<p>See below the actual implementation of <cite>SqlDbStatementBuilder</cite> object for <cite>CreateTruncate</cite> method.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>public string CreateTruncate&lt;TEntity&gt;(QueryBuilder&lt;TEntity&gt; queryBuilder) where TEntity : DataEntity
{
        queryBuilder = queryBuilder ?? new QueryBuilder&lt;TEntity&gt;();
        queryBuilder
                .Clear()
                .Truncate()
                .Table()
                .TableFrom(Command.Delete)
                .End();
        return queryBuilder.GetString();
}
</pre></div>
</div>
</div>
<div class="section" id="createupdate-method">
<h2>CreateUpdate Method<a class="headerlink" href="#createupdate-method" title="Permalink to this headline">¶</a></h2>
<p>This method is being called when the <cite>Update</cite> operation of the repository is being called.</p>
<p>Below are the arguments of <cite>CreateUpdate</cite> method.</p>
<ul class="simple">
<li><strong>queryBuilder</strong>: an instance of query builder used to build the SQL statement.</li>
<li><strong>where</strong>: the expression used when composing a statement (of type <cite>RepoDb.QueryGroup</cite>).</li>
</ul>
<p>See below the actual implementation of <cite>SqlDbStatementBuilder</cite> object for <cite>CreateUpdate</cite> method.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>public string CreateUpdate&lt;TEntity&gt;(QueryBuilder&lt;TEntity&gt; queryBuilder, QueryGroup where) where TEntity : DataEntity
{
        queryBuilder = queryBuilder ?? new QueryBuilder&lt;TEntity&gt;();
        var fields = DataEntityExtension.GetPropertiesFor&lt;TEntity&gt;(Command.Update)
                .Where(property =&gt; property != DataEntityExtension.GetPrimaryProperty&lt;TEntity&gt;())
                .Select(p =&gt; new Field(p.Name));
        queryBuilder
                .Clear()
                .Update()
                .TableFrom(Command.Update)
                .Set()
                .FieldsAndParametersFrom(fields)
                .WhereFrom(where)
                .End();
        return queryBuilder.GetString();
}
</pre></div>
</div>
</div>
<div class="section" id="creating-a-custom-statement-builder">
<h2>Creating a custom Statement Builder<a class="headerlink" href="#creating-a-custom-statement-builder" title="Permalink to this headline">¶</a></h2>
<p>The main reason why the library supports the statement builder is to allow the developers override the default statement builder of the library. By default, the library statement builder is only limited for SQL Server providers (as SQL Statements). However, it will fail if the library is being used to access the Oracle, MySql or any other providers.</p>
<p>To create a custom statement builder, simply create a class and implements the <cite>RepoDb.Interfaces.IStatementBuilder</cite> interface.</p>
<div class="highlight-c# notranslate"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">OracleDbStatementBuilder</span> <span class="p">:</span> <span class="n">IStatementBuilder</span>
<span class="p">{</span>
        <span class="c1">// Implements the IStatementBuilder methods here</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Once the custom statement builder is created, it then can be used as an injectable object into the repository. See sample below injecting a statement builder for Oracle provider.</p>
<div class="highlight-c# notranslate"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">statementBuilder</span> <span class="p">=</span> <span class="k">new</span> <span class="n">OracleDbStatementBuilder</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">repository</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DbRepository</span><span class="p">&lt;</span><span class="n">SqlConnection</span><span class="p">&gt;(</span><span class="s">@&quot;Server=.;Database=Northwind;Integrated Security=SSPI;&quot;</span><span class="p">,</span> <span class="n">statementBuilder</span><span class="p">);</span>
</pre></div>
</div>
<p>With the code snippets above, everytime the repository operation methods is being called, the <cite>OracleStatementBuilder</cite> corresponding method will be executed.</p>
</div>
<div class="section" id="mapping-a-statement-builder">
<h2>Mapping a Statement Builder<a class="headerlink" href="#mapping-a-statement-builder" title="Permalink to this headline">¶</a></h2>
<p>By default, the library is using the <cite>RepoDb.SqlDbStatementBuilder</cite> object for the statement builder. As discussed above, when creating a custom statement builder, it can then be injected as an object in the repository. However, if the developer wants to map the statement builder by provider level, this feature comes into the play.</p>
<p>The mapper is of static type <cite>RepoDb.StatementBuilderMapper</cite>.</p>
<p>The following are the methods of this object.</p>
<ul class="simple">
<li><strong>Get</strong>: returns the instance of statement builder by type (of type <cite>System.Data.IDbConnection</cite>).</li>
<li><strong>Map</strong>: maps the custom statement builder to a type (of type <cite>System.Data.IDbConnection</cite>).</li>
</ul>
<p>Mapping a statement builder enables the developer to map the custom statement builder by provider level.</p>
<p>Let say for example, if the developers created the following repositories:</p>
<blockquote>
<div><ul class="simple">
<li>CustomerRepository (for <cite>SqlConnection</cite>)</li>
<li>ProductRepository (for <cite>SqlConnection</cite>)</li>
<li>OrderRepository (for <cite>OracleConnection</cite>)</li>
<li>CompanyRepository (for <cite>OleDbConnection</cite>)</li>
</ul>
</div></blockquote>
<p>Then, by mapping a custom statement builders, it will enable the library to summon the statement builder based on the provider of the repository. With the following repositories defined above, the developers must implement atleast two (2) custom statement builder (one for Oracle provider and one for OleDb provider).</p>
<p>Let say the developer created 2 new custom statement builders named:</p>
<blockquote>
<div><ul class="simple">
<li>OracleStatementBuilder</li>
<li>OleDbStatementBuilder</li>
</ul>
</div></blockquote>
<p>The developers can now map the following statement builders into the repositories by provider level. Below is the sample way on how to do it.</p>
<div class="highlight-c# notranslate"><div class="highlight"><pre><span></span><span class="n">StatementBuilderMapper</span><span class="p">.</span><span class="n">Map</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">OracleConnection</span><span class="p">),</span> <span class="k">new</span> <span class="n">OracleStatementBuilder</span><span class="p">());</span>
<span class="n">StatementBuilderMapper</span><span class="p">.</span><span class="n">Map</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">OleDbConnection</span><span class="p">),</span> <span class="k">new</span> <span class="n">OleDbStatementBuilder</span><span class="p">());</span>
</pre></div>
</div>
<p>The object <cite>StatementBuilderMapper.Map</cite> is callable everywhere in the application as it was implemented in s static way. Make sure to call it once, or else, an exception will be thrown.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="performance.html" class="btn btn-neutral float-right" title="Performance Benchmark" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="trace.html" class="btn btn-neutral" title="Working with Trace" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Michael Camara Pendon.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.1.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>